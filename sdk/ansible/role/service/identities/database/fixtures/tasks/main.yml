---
- name: Detect custom identities fixtures directory
  local_action: stat path=/root/resource/data/{{ fixtures }}/identities
  register: directory

- name: Backup identities fixtures directory
  shell: cp -R /srv/service/identities/src/AppBundle/Resources/data/{{ fixtures }} /srv/service/identities/src/AppBundle/Resources/data/_{{ fixtures }}
  when: directory.stat.exists == true

- name: Download custom identities fixtures directory
  copy:
      src: /root/resource/data/{{ fixtures }}/identities/
      dest: /srv/service/identities/src/AppBundle/Resources/data/{{ fixtures }}
  when: directory.stat.exists == true

- name: Load identities database fixtures
  shell:
      cmd: 'docker-compose exec identities_php bin/console doctrine:fixtures:load --env={{ fixtures }} --fixtures=/srv/api-platform/src/AppBundle/Fixtures/ORM --no-interaction | cat'
      chdir: /srv/service/identities

# The restore backup task below runs before docker-compose above finishes executing. Look into fixing this.
- name: Pause while identities fixtures load
  pause:
      seconds: 15
  when: directory.stat.exists == true

- name: Delete custom identities fixtures directory
  file:
      path: /srv/service/identities/src/AppBundle/Resources/data/{{ fixtures }}
      state: absent
  when: directory.stat.exists == true

- name: Restore identities fixtures directory backup
  shell: mv /srv/service/identities/src/AppBundle/Resources/data/_{{ fixtures }} /srv/service/identities/src/AppBundle/Resources/data/{{ fixtures }}
  when: directory.stat.exists == true
