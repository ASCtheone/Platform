---
- import_playbook: /etc/ansible/playbook/platform/vars/include.yml
- import_playbook: /etc/ansible/playbook/platform/vars/computed/include.yml

- name: Compile test/validate task list
  hosts: platform
  become: true
  tasks:
    - name: Compile files
      compile:
        app: '{{ app }}'
        directory: /etc/ansible/task/app/*
        task: test/validate
      register: files
  tags: [always]

- name: Validate isolated tests
  hosts: app
  become: true
  tasks:
    - debug:
        var: integrated
      tags: [always]
    - name: Include compiled task list
      include_tasks: '{{ item }}'
      with_items: '{{ hostvars["platform"]["files"]["tasks"] }}'
      when: not integrated
      tags: [always]

- name: Validate integrated tests
  hosts: app
  become: true
  tasks:
    - debug:
        var: integrated
      tags: [always]
    - name: Include app tasks
      include_tasks: /etc/ansible/task/app/test/validate.yml
      when: integrated
      tags: [always]
