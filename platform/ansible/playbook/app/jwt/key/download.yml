---
- name: Compile jwt/key/download task list
  hosts: platform
  become: true
  tasks:
    - name: Compile files
      compile:
        app: '{{ app }}'
        directory: /etc/ansible/task/app/*
        task: jwt/key/download
      register: _result
  tags: [always]

- name: Download jwt private and public key
  hosts: app
  become: true
  tasks:
    - name: Define jwt variables
      set_fact:
        jwt_private_key: '/root/resource/jwt/{{ platform.env|replace(".", "/") }}/key'
        jwt_public_key: '/root/resource/jwt/{{ platform.env|replace(".", "/") }}/key.pub'
      tags: [always]
    - name: Include compiled task list
      include_tasks: '{{ _file }}'
      with_items: '{{ hostvars["platform"]["_result"]["tasks"] }}'
      loop_control:
        loop_var: _file
      tags: [always]
